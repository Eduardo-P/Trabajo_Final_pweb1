<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Lista Paginas Web</title>
        <style>
            ul {
                margin-left: -20px;
            }

            li {
                margin-bottom: 10px;
                display: flex;
                align-items: center;
            }

            form {
                display: inline-block;
                margin-left: 10px;
            }
        </style>
    </head>
    <body>
        <h1>Nuestras paginas de wiki</h1>
        <div id="usuario"></div>

        <div id="articulos">
            <ul id="lista">
            </ul>
        </div>
        
        <hr>
        <a id="nuevaPagina" href="http://localhost/new.html">Nueva Página</a>
        <br>
        <a href="http://localhost/accesoprueba.html">Iniciar sesion con otro usuario</a>
        <br>
        <a href="http://localhost/index.html">Volver al Inicio</a>
        
        <div id="result">
            <div id="estructura" class="contenidoXML">
              <h4>FORMATO XML</h4>
              <pre id="content"></pre>
            </div>
        </div>
        
    </body>
    <script>
        /*
        // Verifica si hay una página referente
        console.log("Página Referente:", document.referrer);
        if (document.referrer === "http://localhost/accesoprueba.html") {
            const xmlUrl1 = "http://localhost/usuario.xml";
            const xmlUrl2 = "http://localhost/listaArticulos.xml";
      
          // Abrir una nueva pestaña con el contenido XML
          const newTab1 = window.open(xmlUrl1, '_blank');
          const newTab2 = window.open(xmlUrl2, '_blank');
      
          // Volver a enfocar en la pestaña actual
          window.focus();
        } else {
            console.log("No hay página referente.");
        }
        */
    </script>
    <script>/*
        document.addEventListener("DOMContentLoaded", function () {
            var xhr = new XMLHttpRequest();

            // Configurar la solicitud
            xhr.open("GET", "usuario.xml", true);

            // Configurar la función de retorno de llamada
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    // Procesar la respuesta XML
                    var xmlDoc = xhr.responseXML;
                    var mensaje = xmlDoc.getElementsByTagName("owner")[0].childNodes[0].nodeValue;

                    // Actualizar el contenido de la página
                    document.getElementById("usuario").innerHTML = mensaje;
                }
            };

            // Enviar la solicitud
            xhr.send();
        });*/
    </script>
    <script>/*
        // Obtener el valor del elemento HTML
        var usuario = document.getElementById("usuario").innerText;
        
        // Hacer la solicitud AJAX
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                // Procesar la respuesta XML
                var xmlDoc = xhr.responseXML;
                var articles = xmlDoc.getElementsByTagName("article");
        
                // Actualizar dinámicamente el contenido de la página
                var lista = document.getElementById("lista");
        
                for (var i = 0; i < articles.length; i++) {
                    var article = articles[i];
                    var title = article.getElementsByTagName("title")[0].textContent;
        
                    var li = document.createElement("li");
                    var a = document.createElement("a");
                    var deleteForm = document.createElement("form");
                    var editForm = document.createElement("form");
        
                    a.href = "view.pl?title=" + encodeURIComponent(title);
                    a.textContent = title;

                    deleteForm.action = "delete.pl";
                    deleteForm.method = "get";
                    var deleteInput = document.createElement("input");
                    deleteInput.type = "hidden";
                    deleteInput.name = "title";
                    deleteInput.value = title;
                    var deleteButton = document.createElement("input");
                    deleteButton.type = "submit";
                    deleteButton.value = "X";
                    deleteForm.appendChild(deleteInput);
                    deleteForm.appendChild(deleteButton);
        
                    editForm.action = "edit.pl";
                    editForm.method = "get";
                    var editInput = document.createElement("input");
                    editInput.type = "hidden";
                    editInput.name = "title";
                    editInput.value = title;
                    var editButton = document.createElement("input");
                    editButton.type = "submit";
                    editButton.value = "E";
                    editForm.appendChild(editInput);
                    editForm.appendChild(editButton);
        
                    li.appendChild(a);
                    li.appendChild(deleteForm);
                    li.appendChild(editForm);
        
                    lista.appendChild(li);
                }
            }
        };
        
        xhr.open("GET", "/cgi-bin/listp.pl?owner=" + encodeURIComponent(usuario), true);
        xhr.send(); */
    </script>
    <script>/*
        document.addEventListener("DOMContentLoaded", function () {
            var xhr = new XMLHttpRequest();
    
            // Configurar la solicitud
            xhr.open("GET", "usuario.xml", true);
    
            // Configurar la función de retorno de llamada
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    // Procesar la respuesta XML
                    var xmlDoc = xhr.responseXML;
                    var mensaje = xmlDoc.getElementsByTagName("owner")[0].childNodes[0].nodeValue;
    
                    // Actualizar el contenido de la página
                    document.getElementById("usuario").innerHTML = mensaje;
    
                    // Segundo script
                    // Obtener el valor del elemento HTML
                    var usuario = document.getElementById("usuario").innerText;
    
                    // Hacer la solicitud AJAX
                    var xhr2 = new XMLHttpRequest();
                    xhr2.onreadystatechange = function () {
                        if (xhr2.readyState === 4 && xhr2.status === 200) {
                            // Procesar la respuesta XML
                            var xmlDoc = xhr2.responseXML;
                            var articles = xmlDoc.getElementsByTagName("article");
    
                            // Actualizar dinámicamente el contenido de la página
                            var lista = document.getElementById("lista");
    
                            for (var i = 0; i < articles.length; i++) {
                                var article = articles[i];
                                var title = article.getElementsByTagName("title")[0].textContent;
    
                                var li = document.createElement("li");
                                var a = document.createElement("a");
                                var deleteForm = document.createElement("form");
                                var editForm = document.createElement("form");
    
                                a.href = "/cgi-bin/view.pl?owner=" + usuario + "&title=" + title;
                                a.textContent = title;
    
                                deleteForm.action = "/cgi-bin/delete.pl";
                                deleteForm.method = "get";
                                deleteForm.id="deleteForm";
                                var deleteTitle = document.createElement("input");
                                deleteTitle.type = "hidden";
                                deleteTitle.name = "title";
                                deleteTitle.id = "title";
                                deleteTitle.value = title;
                                var deleteOwner = document.createElement("input");
                                deleteOwner.type = "hidden";
                                deleteOwner.name = "owner";
                                deleteOwner.id = "owner";
                                deleteOwner.value = usuario;
                                var deleteButton = document.createElement("input");
                                deleteButton.type = "submit";
                                deleteButton.value = "X";
                                deleteForm.appendChild(deleteTitle);
                                deleteForm.appendChild(deleteOwner);
                                deleteForm.appendChild(deleteButton);
    
                                editForm.action = "edit.html";
                                editForm.method = "get";
                                editForm.id="editForm";
                                var editTitle = document.createElement("input");
                                editTitle.type = "hidden";
                                editTitle.name = "title";
                                editTitle.value = title;
                                var editOwner = document.createElement("input");
                                editOwner.type = "hidden";
                                editOwner.name = "owner";
                                editOwner.value = usuario;
                                var editButton = document.createElement("input");
                                editButton.type = "submit";
                                editButton.value = "E";
                                editForm.appendChild(editTitle);
                                editForm.appendChild(editOwner);
                                editForm.appendChild(editButton);
    
                                li.appendChild(a);
                                li.appendChild(deleteForm);
                                li.appendChild(editForm);
    
                                lista.appendChild(li);
                            }
                        }
                    };
    
                    xhr2.open("GET", "/cgi-bin/list.pl?owner=" + encodeURIComponent(usuario), true);
                    xhr2.send();
                }
            };
    
            // Enviar la solicitud
            xhr.send();

            
        });
        // Delegación de eventos en el contenedor "lista"
        document.getElementById("lista").addEventListener("submit", function (event) {
            var form = event.target;

            // Verificar si el formulario enviado es el formulario de eliminación
            if (form.id === "deleteForm") {
                event.preventDefault();

                var formData = new FormData(form);

                fetch(form.action, {
                    method: form.method,
                    body: formData
                })
                    .then(response => response.text())
                    .then(xmlData => {
                        document.getElementById("content").textContent = xmlData;
                        // document.getElementById("result").classList.remove("hidden");
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }
        });*/
    </script>
    <script>/*
        function handleSubmit(event, formId) {
          event.preventDefault();
      
          var form = event.target;
          var formData = new FormData(form);
      
          fetch(form.action, {
            method: form.method,
            body: formData
          })
          .then(response => response.text())
          .then(xmlData => {
            document.getElementById("content").textContent = xmlData;
            document.getElementById("result").classList.remove("hidden");
          })
          .catch(error => {
            console.error('Error:', error);
          });
        }
      
        document.getElementById("deleteForm").addEventListener("submit", function(event) {
          handleSubmit(event, "loginForm");
        });
      
        document.getElementById("editForm").addEventListener("submit", function(event) {
          handleSubmit(event, "signupForm");
        });*/


    </script>
    <script>/*
        document.getElementById("deleteForm").addEventListener("submit", function(event) {
          event.preventDefault();
      
          var form = event.target;
          var formData = new FormData(form);
      
          fetch(form.action, {
            method: form.method,
            body: formData
          })
          .then(response => response.text())
          .then(xmlData => {
            document.getElementById("content").textContent = xmlData;
            //document.getElementById("result").classList.remove("hidden");
          })
          .catch(error => {
            console.error('Error:', error);
          });
        });*/
    </script>
    <script>/*
        function eliminarArticulo() {
            var formulario = document.getElementById("deleteForm");
            var datos = new FormData(formulario);

            var title = formulario.getElementById("title");
            var owner = formulario.getElementById("owner");

            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        // Procesar la respuesta XML
                        var xmlDoc = xhr.responseXML;
                        var resultado = xmlDoc.getElementsByTagName("title")[0].textContent;

                        // Manejar el resultado según tus necesidades
                        console.log("Resultado del servidor:", resultado);
                        document.getElementById("content").textContent = resultado;
                        document.getElementById("result").classList.remove("hidden");
                    } else {
                        // Manejar errores en la solicitud
                        console.error('Error en la solicitud: ' + xhr.status);
                    }
                }
            };

            xhr.open("GET", "/cgi-bin/delete.pl?owner" + owner + "&title" + title, true);
            xhr.send();
        }*/
    </script>
    <script>
    var parametros = new URLSearchParams(window.location.search);
        var owner = parametros.get('owner');

        document.getElementById("usuario").innerHTML = owner;

        var enlace = document.getElementById("nuevaPagina");
        enlace.href = enlace.href + "?owner=" + owner;

    document.addEventListener("DOMContentLoaded", function () {

                // Hacer la solicitud AJAX
                var xhr2 = new XMLHttpRequest();
                xhr2.onreadystatechange = function () {
                    if (xhr2.readyState === 4 && xhr2.status === 200) {
                        // Procesar la respuesta XML
                        var xmlDoc = xhr2.responseXML;
                        var articles = xmlDoc.getElementsByTagName("article");
    
                        // Actualizar dinámicamente el contenido de la página
                        var lista = document.getElementById("lista");
    
                        for (var i = 0; i < articles.length; i++) {
                            var article = articles[i];
                            var title = article.getElementsByTagName("title")[0].textContent;
    
                            var li = document.createElement("li");
                            var a = document.createElement("a");
                            var deleteForm = document.createElement("form");
                            var editForm = document.createElement("form");
                            var viewForm = document.createElement("form");

                            li.id = title;
    
                            a.href = "/cgi-bin/view.pl?owner=" + owner + "&title=" + title;
                            a.textContent = title;
    
                            deleteForm.action = "/cgi-bin/delete.pl";
                            deleteForm.method = "post";
                            deleteForm.id = "deleteForm";
                            var deleteOwner = document.createElement("input");
                            deleteOwner.type = "hidden";
                            deleteOwner.name = "owner";
                            //deleteOwner.id = "owner";
                            deleteOwner.value = owner;
                            var deleteTitle = document.createElement("input");
                            deleteTitle.type = "hidden";
                            deleteTitle.name = "title";
                            //deleteTitle.id = "title";
                            deleteTitle.value = title;
                            var deleteButton = document.createElement("input");
                            deleteButton.type = "submit";
                            deleteButton.value = "X";
                            deleteForm.appendChild(deleteOwner);
                            deleteForm.appendChild(deleteTitle);
                            deleteForm.appendChild(deleteButton);
    
                            editForm.action = "edit.html";
                            editForm.method = "get";
                            editForm.id = "editForm";
                            var editOwner = document.createElement("input");
                            editOwner.type = "hidden";
                            editOwner.name = "owner";
                            editOwner.value = owner;
                            var editTitle = document.createElement("input");
                            editTitle.type = "hidden";
                            editTitle.name = "title";
                            editTitle.value = title;
                            var editButton = document.createElement("input");
                            editButton.type = "submit";
                            editButton.value = "E";
                            editForm.appendChild(editOwner);
                            editForm.appendChild(editTitle);
                            editForm.appendChild(editButton);

                            viewForm.action = "/cgi-bin/article.pl";
                            viewForm.method = "post";
                            viewForm.id = "viewForm";
                            var viewOwner = document.createElement("input");
                            viewOwner.type = "hidden";
                            viewOwner.name = "owner";
                            viewOwner.value = owner;
                            var viewTitle = document.createElement("input");
                            viewTitle.type = "hidden";
                            viewTitle.name = "title";
                            viewTitle.value = title;
                            var viewButton = document.createElement("input");
                            viewButton.type = "submit";
                            viewButton.value = "V";
                            viewForm.appendChild(viewOwner);
                            viewForm.appendChild(viewTitle);
                            viewForm.appendChild(viewButton);
    
                            li.appendChild(a);
                            li.appendChild(deleteForm);
                            li.appendChild(editForm);
                            li.appendChild(viewForm);
    
                            lista.appendChild(li);
                        }
                    }
                };
    
                xhr2.open("GET", "/cgi-bin/list.pl?owner=" + encodeURIComponent(owner), true);
                xhr2.send();
            }
        );
    
    // Delegación de eventos en el contenedor "lista"
    document.getElementById("lista").addEventListener("submit", function (event) {
        var form = event.target;
    
        // Verificar si el formulario enviado es un formulario de eliminación
        if (form.tagName === "FORM" && form.id === "deleteForm") {
            event.preventDefault();
    
            var formData = new FormData(form);
    
            fetch(form.action, {
                method: form.method,
                body: formData
            })
                .then(response => response.text())
                .then(xmlData => {
                    var parser = new DOMParser();
                    var xmlDoc = parser.parseFromString(xmlData, "text/xml");

                    var titleElement = xmlDoc.querySelector('title');

                    if (titleElement) {
                        // Primera forma: Dirección a new.pl con parámetros title y text
                        var titleValue = titleElement.textContent;

                        // Obtener el elemento por su ID
                        var eliminarArticulo = document.getElementById(titleValue);

                        var lista = document.getElementById("lista");
                        lista.removeChild(eliminarArticulo);

                        document.getElementById("content").textContent = "Se elimino correctamente el articulo " + titleValue;
                    } else {
                        document.getElementById("content").textContent = "Error al eliminar el articulo!";
                    }
                    document.getElementById("result").classList.remove("hidden");

                    setTimeout(function () {
                        document.getElementById("result").classList.add("hidden");
                        // También puedes realizar otra acción aquí después de 10 segundos
                    }, 10000);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        if (form.tagName === "FORM" && form.id === "viewForm") {
            event.preventDefault();
      
          var form = event.target;
          var formData = new FormData(form);
      
          fetch(form.action, {
            method: form.method,
            body: formData
          })
          .then(response => response.text())
          .then(xmlData => {
            var parser = new DOMParser();
                var xmlDoc = parser.parseFromString(xmlData, "text/xml");

                  var titleValue = xmlDoc.querySelector('title').textContent;
                  var textValue = xmlDoc.querySelector('text').textContent;
                  window.location.href = "/cgi-bin/viewMarkdown.pl?owner=" + encodeURIComponent(owner) +"&title=" + encodeURIComponent(titleValue) + "&text=" + encodeURIComponent(textValue);
                
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    });

    </script>
    <script>/*
        document.getElementById("viewForm").addEventListener("submit", function(event) {
          event.preventDefault();
      
          var form = event.target;
          var formData = new FormData(form);
      
          fetch(form.action, {
            method: form.method,
            body: formData
          })
          .then(response => response.text())
          .then(xmlData => {
            var parser = new DOMParser();
                var xmlDoc = parser.parseFromString(xmlData, "text/xml");

                  var titleValue = xmlDoc.querySelector('title').textContent;
                  var textValue = xmlDoc.querySelector('text').textContent;
                  window.location.href = "/cgi-bin/viewMarkdown.pl?owner=" + encodeURIComponent(owner) +"&title=" + encodeURIComponent(titleValue) + "&text=" + encodeURIComponent(textValue);
                
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });*/
    </script>
</html>